
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>LSTM åŸç†åŠå…¶ PyTorch å®ç° | Cold Rain&#39;s Blog</title>
    <meta name="author" content="ColdRain" />
    <meta name="description" content="éŠ€ã®é¾ã®èƒŒã«ä¹—ã£ã¦..." />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/head.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/vs.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜ æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>COLD RAIN&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Homepage</span>
        </a>
        
        <a href="/2024/11/26/test">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories/%E6%9D%82%E8%B0%88">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags/%E6%9D%82%E8%B0%88">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/friends">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;COLD RAIN&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Homepage</div>
                    </div>
                </a>
                
                <a href="/2024/11/26/test">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories/%E6%9D%82%E8%B0%88">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags/%E6%9D%82%E8%B0%88">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
                <a href="/friends">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-link fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    
    
        <!-- post éƒ¨åˆ†è®¾è®¡ -->

        <div class="article-wrap">

            
            <div class="article-content">
                
                <div>
                    <h1>LSTM åŸç†åŠå…¶ PyTorch å®ç°</h1>
                </div>

                <div class="info">
                    <span class="date">
                        <span class="icon">
                            <i class="fa-solid fa-calendar fa-fw"></i>
                        </span>
                        2024/12/13
                    </span>

                    
                        <span class="category">
                            <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                                <span class="icon">
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                </span>
                                æ·±åº¦å­¦ä¹ 
                            </a>
                        </span>
                    

                    
                        <span class="tags">
                            <span class="icon">
                                <i class="fa-solid fa-tags fa-fw"></i>
                            </span>
                            
                            
                                <span class="tag">
                                    
                                    <a href="/tags/PyTorch/" style="color: #ff7d73">
                                        PyTorch
                                    </a>
                                </span>
                            
                                <span class="tag">
                                    
                                    <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="color: #03a9f4">
                                        æ·±åº¦å­¦ä¹ 
                                    </a>
                                </span>
                            
                                <span class="tag">
                                    
                                    <a href="/tags/RNN/" style="color: #ff7d73">
                                        RNN
                                    </a>
                                </span>
                            
                        </span>
                    
                </div>

                
                    <!-- æ˜¾ç¤ºæ–‡ç« ç‰¹æœ‰çš„æ¨¡å—ï¼ˆå¦‚æ ‡ç­¾ã€åˆ†ç±»ï¼‰ -->
                    <div class="content" v-pre>
                        
                        <blockquote>
<p>PyTorch å…¶å®å†…ç½®äº† LSTM æ¨¡å‹ï¼Œç›´æ¥è°ƒç”¨å³å¯ï¼Œä¸éœ€è¦è´¹åŠ²å»æ‰‹æ“äº†</p>
<p>ï¼ˆæŸä¸ªäººå¤ç°åˆ°ä¸€åŠæ‰ååº”è¿‡æ¥ ğŸ˜­ï¼‰</p>
<p>âœ¨é€šä¿—æ˜“æ‡‚çš„ LSTM åŸç†è®²è§£ï¼ˆåŠ›æ¨ï¼‰ï¼š<br>
<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YCzL96nL7j0&amp;t=1s">https://www.youtube.com/watch?v=YCzL96nL7j0&amp;t=1s</a></p>
<p>ï¼ˆ å‘æ˜ LSTM çš„äººçœŸ ** æ˜¯ä¸ªå¤©æ‰ï¼ï¼‰</p>
</blockquote>
<h2><span id="1-ä»€ä¹ˆæ˜¯-lstm">1. â“ ä»€ä¹ˆæ˜¯ LSTM</span></h2>
<p>é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼ŒLong-Short-Term Memoryï¼‰æ˜¯ä¼ ç»Ÿ RNN ç½‘ç»œçš„ Plus ç‰ˆæœ¬ã€‚</p>
<h3><span id="11-å‘æ˜èƒŒæ™¯">1.1 å‘æ˜èƒŒæ™¯</span></h3>
<p>ä¼ ç»Ÿçš„ RNN ç½‘ç»œåœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œå½“é‡åˆ°é•¿åºåˆ—æ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“å‡ºç° <strong>æ¢¯åº¦çˆ†ç‚¸</strong> ä¸ <strong>æ¢¯åº¦æ¶ˆå¤±</strong> çš„æƒ…å†µï¼Œå¯¼è‡´è®­ç»ƒæ•ˆæœä¸å¤ªå¥½ã€‚</p>
<blockquote>
<p>ğŸ‘€ ä»€ä¹ˆï¼Ÿä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ <strong>æ¢¯åº¦çˆ†ç‚¸</strong> å’Œ <strong>æ¢¯åº¦æ¶ˆå¤±</strong>ï¼Ÿï¼å¿«æ¥çœ‹çœ‹è¿™ä¸ªè§†é¢‘ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=AsNTP8Kwu80">https://www.youtube.com/watch?v=AsNTP8Kwu80</a></p>
</blockquote>
<p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒLSTM åœ¨ä¼ ç»Ÿ RNN çš„åŸºç¡€ä¸Šï¼ŒåŠ å…¥äº† <strong>é—¨æ§æœºåˆ¶ï¼ˆGateï¼‰</strong> æ¥æ§åˆ¶ä¿¡æ¯æµåŠ¨ï¼Œä»è€Œè®°ä½é•¿æœŸä¾èµ–ä¿¡æ¯ã€‚</p>
<h3><span id="12-åŸç†è¯¦è§£">1.2 åŸç†è¯¦è§£</span></h3>
<blockquote>
<p>å…ˆçœ‹è§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YCzL96nL7j0&amp;t=1s">https://www.youtube.com/watch?v=YCzL96nL7j0&amp;t=1s</a></p>
</blockquote>
<p>LSTM ç”±å¤šä¸ª <strong>LSTM å•å…ƒï¼ˆCellï¼‰</strong> ç»„æˆï¼Œæ¯ä¸ªå•å…ƒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªé—¨å’Œä¸€ä¸ªå•å…ƒçŠ¶æ€ï¼š</p>
<h4><span id="é—å¿˜é—¨forget-gate"><strong>é—å¿˜é—¨ï¼ˆForget Gateï¼‰</strong></span></h4>
<ul>
<li><strong>åŠŸèƒ½ï¼š</strong> å†³å®šå“ªäº›ä¿¡æ¯éœ€è¦ <strong>é—å¿˜</strong>ã€‚</li>
<li><strong>å…¬å¼ï¼š</strong><br>
$$ f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f) $$</li>
<li><strong>è§£é‡Šï¼š</strong>
<ul>
<li>è¾“å…¥ï¼šå‰ä¸€ä¸ªéšè—çŠ¶æ€ $h_{t-1}$ å’Œå½“å‰è¾“å…¥ $x_t$ã€‚</li>
<li>è¾“å‡ºï¼šèŒƒå›´åœ¨ $[0, 1]$ï¼Œå…¶ä¸­ 0 è¡¨ç¤ºå®Œå…¨é—å¿˜ï¼Œ1 è¡¨ç¤ºå®Œå…¨ä¿ç•™ã€‚</li>
</ul>
</li>
</ul>
<h4><span id="è¾“å…¥é—¨input-gate"><strong>è¾“å…¥é—¨ï¼ˆInput Gateï¼‰</strong></span></h4>
<ul>
<li><strong>åŠŸèƒ½ï¼š</strong> å†³å®šå“ªäº›æ–°ä¿¡æ¯éœ€è¦ <strong>å­˜å‚¨</strong>ã€‚</li>
<li><strong>å…¬å¼ï¼š</strong>
<ul>
<li>å€™é€‰ä¿¡æ¯ç”Ÿæˆï¼š<br>
$$ \tilde{C}<em>t = \tanh(W_C \cdot [h</em>{t-1}, x_t] + b_C)$$</li>
<li>è¾“å…¥é—¨æ¿€æ´»ï¼š<br>
$$i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i)$$</li>
<li>æ›´æ–°å•å…ƒçŠ¶æ€ï¼š<br>
$$C_t = f_t \cdot C_{t-1} + i_t \cdot \tilde{C}_t$$</li>
</ul>
</li>
<li><strong>è§£é‡Šï¼š</strong>
<ul>
<li>å€™é€‰ä¿¡æ¯ $\tilde{C}_t$ï¼šå½“å‰æ—¶é—´æ­¥çš„æ–°ä¿¡æ¯ã€‚</li>
<li>è¾“å…¥é—¨ $i_t$ï¼šæ§åˆ¶å€™é€‰ä¿¡æ¯çš„å­˜å‚¨ç¨‹åº¦ã€‚</li>
</ul>
</li>
</ul>
<h4><span id="è¾“å‡ºé—¨output-gate"><strong>è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰</strong></span></h4>
<ul>
<li><strong>åŠŸèƒ½ï¼š</strong> å†³å®šå•å…ƒçŠ¶æ€ä¸­çš„ä¿¡æ¯ <strong>å…¬å¼€è¾“å‡º</strong>ã€‚</li>
<li><strong>å…¬å¼ï¼š</strong>
<ul>
<li>è¾“å‡ºé—¨æ¿€æ´»ï¼š<br>
$$o_t = \sigma(W_o \cdot [h_{t-1}, x_t] + b_o)$$</li>
<li>æœ€ç»ˆéšè—çŠ¶æ€ï¼š<br>
$$h_t = o_t \cdot \tanh(C_t)$$</li>
</ul>
</li>
<li><strong>è§£é‡Šï¼š</strong>
<ul>
<li>è¾“å‡ºé—¨å†³å®šå½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_t$ï¼Œè¯¥çŠ¶æ€å°†ä½œä¸ºä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥ã€‚</li>
</ul>
</li>
</ul>
<h4><span id="å•å…ƒçŠ¶æ€cell-state"><strong>å•å…ƒçŠ¶æ€ï¼ˆCell Stateï¼‰</strong></span></h4>
<ul>
<li><strong>åŠŸèƒ½ï¼š</strong>
<ul>
<li>ä½œä¸ºä¿¡æ¯çš„â€œé•¿æœŸè®°å¿†â€è·¯å¾„ï¼Œåœ¨æ•´ä¸ªæ—¶é—´åºåˆ—ä¸­æµåŠ¨ã€‚</li>
<li>çº¿æ€§ä¼ é€’ï¼Œå‡ ä¹ä¸å—æ¿€æ´»å‡½æ•°çš„å½±å“ï¼Œç¡®ä¿é•¿æ—¶é—´çš„ä¿¡æ¯ä¿ç•™ã€‚</li>
</ul>
</li>
</ul>
<h3><span id="13-lstm-æ•°æ®æµæ€»ç»“">1.3 LSTM æ•°æ®æµæ€»ç»“ï¼š</span></h3>
<ol>
<li>æ¥æ”¶è¾“å…¥ $x_t$ å’Œä¸Šä¸€ä¸ªéšè—çŠ¶æ€ $h_{t-1}$ã€‚</li>
<li><strong>é—å¿˜é—¨</strong> ç¡®å®šéœ€è¦é—å¿˜çš„ä¿¡æ¯ã€‚</li>
<li><strong>è¾“å…¥é—¨</strong> ç¡®å®šå­˜å‚¨çš„æ–°ä¿¡æ¯ã€‚</li>
<li>æ›´æ–°å•å…ƒçŠ¶æ€ $C_t$ã€‚</li>
<li><strong>è¾“å‡ºé—¨</strong> ç¡®å®šå½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºéšè—çŠ¶æ€ $h_t$ã€‚</li>
</ol>
<h3><span id="14-lstm-çš„ä¼˜åŠ¿">1.4 LSTM çš„ä¼˜åŠ¿ï¼š</span></h3>
<ul>
<li><strong>é•¿æœŸä¾èµ–è®°å¿†ï¼š</strong> èƒ½å¤Ÿæœ‰æ•ˆè®°ä½é•¿æœŸä¿¡æ¯ï¼Œè§£å†³äº†ä¼ ç»Ÿ RNN çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¹¿æ³›ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ã€æ—¶é—´åºåˆ—é¢„æµ‹ã€è¯­éŸ³è¯†åˆ«ç­‰é¢†åŸŸã€‚</li>
<li><strong>çµæ´»æ€§é«˜ï¼š</strong> æ”¯æŒå¤šå±‚å †å ï¼Œèƒ½å¤Ÿå­¦ä¹ é«˜åº¦å¤æ‚çš„æ•°æ®æ¨¡å¼ã€‚</li>
</ul>
<hr>
<h2><span id="2-pytorch-æ‰‹åŠ¨å¤ç°-lstmçµæ´»åº¦é«˜">2. PyTorch æ‰‹åŠ¨å¤ç° LSTMï¼ˆçµæ´»åº¦é«˜ï¼‰</span></h2>
<blockquote>
<p>å‚è€ƒæ•™ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RHGiXPuo_pI">https://www.youtube.com/watch?v=RHGiXPuo_pI</a></p>
</blockquote>
<h3><span id="21-å¯¼å…¥åŒ…">2.1 ğŸ“¦å¯¼å…¥åŒ…</span></h3>
<pre><code class="language-Python">import torch
import torch.nn as nn
import torch.nn.functional as F
from torch.optim import Adam

import lightning as L
from torch.utils.data import TensorDataset, DataLoader
</code></pre>
<p>âš ï¸æ³¨æ„ï¼šè¿™é‡Œæœ‰ä¸ªå« <code>lightning</code> çš„åŒ…ã€‚</p>
<blockquote>
<p>ä»€ä¹ˆï¼Ÿä½ ä¸çŸ¥é“è¿™ä¸ªåŒ…æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Ÿï¼PyTorch Lightning æ˜¯ä¸€ä¸ªåŸºäº PyTorch çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå…¶åŠŸèƒ½ç›¸å½“å¼ºå¤§ï¼Œå¯ä»¥ä¸€é”®å®ç°å¾ˆå¤šåŠŸèƒ½ï¼</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://lightning.ai/docs/pytorch/stable/">https://lightning.ai/docs/pytorch/stable/</a></p>
<p>ä¸‹è½½æ–¹å¼:</p>
<ol>
<li>pip ç”¨æˆ·ï¼š</li>
</ol>
<pre><code class="language-Terminal">pip install lightning
</code></pre>
<ol start="2">
<li>conda ç”¨æˆ·ï¼š</li>
</ol>
<pre><code class="language-Terminal">conda install lightning
</code></pre>
</blockquote>
<h3><span id="22-æ‰‹æ“-lstm-ç½‘ç»œ">2.2 âœ‹æ‰‹æ“ LSTM ç½‘ç»œ</span></h3>
<pre><code class="language-Python">class LSTMbyHand(L.LightningModule):
    def __init__(self):
        # create and initialize weight and bias tensors
        super().__init__()
        mean = torch.tensor(0.0)
        std = torch.tensor(1.0)

        ## 1. é—å¿˜é—¨ 
        self.wlr1 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.wlr2 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.blr1 = nn.Parameter(torch.tensor(0.), requires_grad=True)

        ## 2. è¾“å…¥é—¨
        self.wpr1 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.wpr2 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.bpr1 = nn.Parameter(torch.tensor(0.), requires_grad=True)

        self.wp1 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.wp2 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.bp1 = nn.Parameter(torch.tensor(0.), requires_grad=True)

        ## 3. è¾“å‡ºé—¨
        self.wo1 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.wo2 = nn.Parameter(torch.normal(mean=mean, std=std), requires_grad=True)
        self.bo1 = nn.Parameter(torch.tensor(0.), requires_grad=True)


    def lstm_unit(self, input_value, long_memory, short_memory):
        # do the lstm math
        ## 1. é—å¿˜é—¨
        long_remember_percent = torch.sigmoid((short_memory * self.wlr1) +
                                              (input_value * self.wlr2) +
                                              self.blr1)
        
        ## 2. è¾“å…¥é—¨
        potential_remember_percent = torch.sigmoid((short_memory * self.wpr1) +
                                                   (input_value * self.wpr2) +
                                                   self.bpr1)
        
        potential_memory = torch.tanh((short_memory * self.wp1) +
                                      (input_value * self.wp2) +
                                      self.bp1)
        
        updated_long_memory = ((long_memory * long_remember_percent) +
                              (potential_memory * potential_remember_percent))
        
        ## 3. è¾“å‡ºé—¨
        output_percent = torch.sigmoid((short_memory * self.wo1) +
                                       (input_value * self.wo2) +
                                       self.bo1)
        
        updated_short_memory = torch.tanh(updated_long_memory) * output_percent

        ## 4. è¾“å‡º
        return ([updated_long_memory, updated_short_memory])


    def forward(self, input):
        # make a forward pass through unrolled lstm
        long_memory = 0
        short_memory = 0
        day1 = input[0]
        day2 = input[1]
        day3 = input[2]
        day4 = input[3]

        long_memory, short_memory = self.lstm_unit(day1, long_memory, short_memory)
        long_memory, short_memory = self.lstm_unit(day2, long_memory, short_memory)
        long_memory, short_memory = self.lstm_unit(day3, long_memory, short_memory)
        long_memory, short_memory = self.lstm_unit(day4, long_memory, short_memory)

        return short_memory


    def configure_optimizers(self):
        # configure adam optimizer
        return Adam(self.parameters())
    

    def training_step(self, batch, batch_idx):
        # calculate loss and log training progress
        input_i, label_i = batch
        output_i = self.forward(input_i[0])
        loss = (output_i - label_i) ** 2

        self.log(&quot;train_loss&quot;, loss)
        
        if (label_i == 0):
            self.log(&quot;out_0&quot;, output_i)
        else:
            self.log(&quot;out_1&quot;, output_i)

        return loss
</code></pre>
<h3><span id="23-æ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®æ­å»º">2.3 ğŸ”æ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®æ­å»º</span></h3>
<pre><code class="language-Python">model = LSTMbyHand()

print(&quot;\nNow let's compare the observed and predicted values...&quot;)
print(&quot;Company A: Observed = 0, Predicted = &quot;, model(torch.tensor([0., 0.5, 0.25, 1.])).detach())

print(&quot;Company B: Observed = 1, Predicted = &quot;, model(torch.tensor([1., 0.5, 0.25, 1.])).detach())
</code></pre>
<h3><span id="24-å¼€å§‹è®­ç»ƒ">2.4 ğŸ’ªå¼€å§‹è®­ç»ƒ</span></h3>
<pre><code class="language-Python">inputs = torch.tensor([[0., 0.5, 0.25, 1.], [1., 0.5, 0.25, 1.]])
labels = torch.tensor([0., 1.])

dataset = TensorDataset(inputs, labels)
dataloader = DataLoader(dataset)

trainer = L.Trainer(max_epochs=2000)
trainer.fit(model, train_dataloaders=dataloader)
</code></pre>
<h3><span id="25-æ£€æŸ¥è®­ç»ƒæ•ˆæœ">2.5 ğŸ”æ£€æŸ¥è®­ç»ƒæ•ˆæœ</span></h3>
<pre><code class="language-Terminal">tensorboard --logdir=lightning_logs/
</code></pre>
<p><img src="./images/lstm/tensorboard1.png" alt="result"></p>
<p>å‘ç°æ•ˆæœä¸€èˆ¬ğŸ˜¢</p>
<h3><span id="26-è¿ç§»å­¦ä¹ ">2.6 ğŸ’ªè¿ç§»å­¦ä¹ </span></h3>
<pre><code class="language-Python">path_to_best_checkpoint = trainer.checkpoint_callback.best_model_path

trainer = L.Trainer(max_epochs=5000)
trainer.fit(model, train_dataloaders=dataloader, ckpt_path=path_to_best_checkpoint)
</code></pre>
<p>å†æ¬¡æŸ¥çœ‹æ•ˆæœï¼š</p>
<p><img src="./images/lstm/tensorboard3.png" alt="result2"></p>
<p>æ•ˆæœå·¨å¥½ğŸ‘Œ</p>
<h2><span id="3-pytorch-å†…ç½®-lstm-çš„ä½¿ç”¨">3. PyTorch å†…ç½® LSTM çš„ä½¿ç”¨</span></h2>
<h3><span id="31-å¯¼å…¥åŒ…">3.1 ğŸ“¦å¯¼å…¥åŒ…</span></h3>
<pre><code class="language-Python">import torch
import torch.nn as nn
import torch.nn.functional as F
from torch.optim import Adam

import lightning as L
from torch.utils.data import TensorDataset, DataLoader
</code></pre>
<h3><span id="32-æ­å»ºç½‘ç»œ">3.2 ğŸ§±æ­å»ºç½‘ç»œ</span></h3>
<pre><code class="language-Python">class LightningLSTM(L.LightningModule):
    def __init__(self):
        super().__init__()
        self.lstm = nn.LSTM(input_size=1, hidden_size=1)

    
    def forward(self, input):
        input_trans = input.view(len(input), 1)

        lstm_out, temp = self.lstm(input_trans)

        prediction = lstm_out[-1]
        return prediction
    

    def configure_optimizers(self):
        return Adam(self.parameters(), lr=0.1)
    

    def training_step(self, batch, batch_idx):
        input_i, label_i = batch
        output_i = self.forward(input_i[0])
        loss = (output_i - label_i) ** 2

        self.log(&quot;train_loss&quot;, loss)

        if (label_i==0):
            self.log(&quot;out_0&quot;, output_i)
        else:
            self.log(&quot;out_1&quot;, output_i)

        return loss
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ PyTorch ä¸­ï¼ŒLSTM çš„è¾“å…¥æ ¼å¼ä¸º <code>(batch_size, sequence_length, input_size)</code>ï¼Œå³<strong>æ ·æœ¬æ•°é‡ã€æ—¶é—´æ­¥é•¿ã€ç‰¹å¾æ•°é‡</strong>ã€‚</p>
<p>å¦‚æœå®é™…ä¸­çš„æ•°æ®æ ¼å¼ä¸æ­¤ä¸åŒï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æˆå¯¹åº”çš„æ ¼å¼ã€‚</p>
<h3><span id="33-å¼€å§‹è®­ç»ƒ">3.3 ğŸ’ªå¼€å§‹è®­ç»ƒ</span></h3>
<pre><code class="language-Python">model = LightningLSTM()

trainer = L.Trainer(max_epochs=300, log_every_n_steps=2)
trainer.fit(model, train_dataloaders=dataloader)
</code></pre>

                    </div>
                
            </div>

            <div class="article-toc">
                
                    <div id="post-toc-card">
                        <div id="toc-card-style">
    <div id="toc-card-div">
        <div class="the-toc">
            
        <div id='toc'>
            <strong class="sidebar-title"> ç›®å½• </strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">1. â“ ä»€ä¹ˆæ˜¯ LSTM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">1.1 å‘æ˜èƒŒæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">1.2 åŸç†è¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text">é—å¿˜é—¨ï¼ˆForget Gateï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text">è¾“å…¥é—¨ï¼ˆInput Gateï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text">è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text">å•å…ƒçŠ¶æ€ï¼ˆCell Stateï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">1.3 LSTM æ•°æ®æµæ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">1.4 LSTM çš„ä¼˜åŠ¿ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">2. PyTorch æ‰‹åŠ¨å¤ç° LSTMï¼ˆçµæ´»åº¦é«˜ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.1 ğŸ“¦å¯¼å…¥åŒ…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.2 âœ‹æ‰‹æ“ LSTM ç½‘ç»œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.3 ğŸ”æ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®æ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.4 ğŸ’ªå¼€å§‹è®­ç»ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.5 ğŸ”æ£€æŸ¥è®­ç»ƒæ•ˆæœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">2.6 ğŸ’ªè¿ç§»å­¦ä¹ </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">3. PyTorch å†…ç½® LSTM çš„ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">3.1 ğŸ“¦å¯¼å…¥åŒ…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">3.2 ğŸ§±æ­å»ºç½‘ç»œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">3.3 ğŸ’ªå¼€å§‹è®­ç»ƒ</span></a></li></ol></li></ol>
        </div>
    
        </div>
    </div>
</div>
                    </div>
                
            </div>
        </div>

        <!-- è¿™é‡Œæ’å…¥è¯„è®ºåŒºå’Œé¡µè„š -->
        
            
            
            
            
        


    

</div>
            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 Cold Rain&#39;s Blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;ColdRain
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>

<canvas
    id="background"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"
></canvas>
<script src="/js/background.min.js"></script>

</html>
