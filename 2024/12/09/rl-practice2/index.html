
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>Kaggle：Playground S4 E8 | Cold Rain&#39;s Blog</title>
    <meta name="author" content="冷雨" />
    <meta name="description" content="希望能成为一个厉害的人" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/head.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>COLD RAIN&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
        <a href="/2024/11/26/test">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;简介</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;归档</span>
        </a>
        
        <a href="/categories/%E6%9D%82%E8%B0%88">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;分类</span>
        </a>
        
        <a href="/tags/%E6%9D%82%E8%B0%88">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;标签</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;COLD RAIN&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                    </div>
                </a>
                
                <a href="/2024/11/26/test">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">简介</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">归档</div>
                    </div>
                </a>
                
                <a href="/categories/%E6%9D%82%E8%B0%88">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">分类</div>
                    </div>
                </a>
                
                <a href="/tags/%E6%9D%82%E8%B0%88">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">标签</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Kaggle：Playground S4 E8</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/12/9
        </span>
        
        <span class="category">
            <a href="/categories/Kaggle-%E7%BB%83%E4%B9%A0/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Kaggle 练习
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="color: #ffa2c4">
                    深度学习
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/PyTorch/" style="color: #00bcd4">
                    PyTorch
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <blockquote>
<p>🔗比赛链接：<a target="_blank" rel="noopener" href="https://www.kaggle.com/competitions/playground-series-s4e8">https://www.kaggle.com/competitions/playground-series-s4e8</a></p>
<p>训练数据集、测试数据集和提交样例都需要自行从比赛页面下载。</p>
</blockquote>
<h2 id="一、📦导入必要的包"><a href="#一、📦导入必要的包" class="headerlink" title="一、📦导入必要的包"></a>一、📦导入必要的包</h2><pre><code class="Python"># 数据处理
import numpy as np
import pandas as pd

# 搭建模型
from sklearn.model_selection import train_test_split, StratifiedKFold
from sklearn.metrics import accuracy_score, matthews_corrcoef

# PyTorch
import copy
import torch
import torch.nn as nn
import torch.optim as optim
import tqdm

# 探索特征
from sklearn.preprocessing import LabelEncoder
from sklearn.preprocessing import OrdinalEncoder
from sklearn.feature_selection import SelectKBest
from sklearn.feature_selection import chi2
from matplotlib import pyplot

import os
</code></pre>
<h2 id="二、🪵导入训练数据与测试数据"><a href="#二、🪵导入训练数据与测试数据" class="headerlink" title="二、🪵导入训练数据与测试数据"></a>二、🪵导入训练数据与测试数据</h2><h3 id="1-导入训练数据"><a href="#1-导入训练数据" class="headerlink" title="1. 导入训练数据"></a>1. 导入训练数据</h3><pre><code class="Python"># 导入训练数据
train = pd.read_csv(&quot;train.csv&quot;)
train.head()
</code></pre>
<p>输出如下（由于 categories 过长，这里展示一部分结果）：</p>
<pre><code class="Terminal">   id class  cap-diameter cap-shape  ... ring-type spore-print-color habitat season
0   0     e          8.80         f  ...         f               NaN       d      a
1   1     p          4.51         x  ...         z               NaN       d      w
2   2     e          6.94         f  ...         f               NaN       l      w
3   3     e          3.88         f  ...         f               NaN       d      u
4   4     e          5.85         x  ...         f               NaN       g      a

[5 rows x 22 columns]
</code></pre>
<h3 id="2-导入测试数据"><a href="#2-导入测试数据" class="headerlink" title="2. 导入测试数据"></a>2. 导入测试数据</h3><pre><code class="Python"># 导入测试数据
test = pd.read_csv(&quot;test.csv&quot;)
test.head()
</code></pre>
<p>输出如下（由于 categories 过长，这里展示一部分结果）：</p>
<pre><code class="Terminal">        id  cap-diameter cap-shape  ... spore-print-color habitat season
0  3116945          8.64         x  ...               NaN       d      a
1  3116946          6.90         o  ...               NaN       d      a
2  3116947          2.00         b  ...               NaN       d      s
3  3116948          3.47         x  ...               NaN       d      u
4  3116949          6.17         x  ...               NaN       d      u

[5 rows x 21 columns]
</code></pre>
<blockquote>
<p>观察数据内容发现 test.csv 中没一行没有 “class”，即 test.csv 是需要被分类的数据。</p>
</blockquote>
<h2 id="三、🔍数据分析"><a href="#三、🔍数据分析" class="headerlink" title="三、🔍数据分析"></a>三、🔍数据分析</h2><h3 id="1-数据信息"><a href="#1-数据信息" class="headerlink" title="1. 数据信息"></a>1. 数据信息</h3><pre><code class="Python">train.info(verbose=True, show_counts=True)
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 3116945 entries, 0 to 3116944
Data columns (total 22 columns):
 #   Column                Non-Null Count    Dtype  
---  ------                --------------    -----  
 0   id                    3116945 non-null  int64  
 1   class                 3116945 non-null  object 
 2   cap-diameter          3116941 non-null  float64
 3   cap-shape             3116905 non-null  object 
 4   cap-surface           2445922 non-null  object 
 5   cap-color             3116933 non-null  object 
 6   does-bruise-or-bleed  3116937 non-null  object 
 7   gill-attachment       2593009 non-null  object 
 8   gill-spacing          1858510 non-null  object 
 9   gill-color            3116888 non-null  object 
 10  stem-height           3116945 non-null  float64
 11  stem-width            3116945 non-null  float64
 12  stem-root             359922 non-null   object 
 13  stem-surface          1136084 non-null  object 
 14  stem-color            3116907 non-null  object 
 15  veil-type             159452 non-null   object 
 16  veil-color            375998 non-null   object 
 17  has-ring              3116921 non-null  object 
 18  ring-type             2988065 non-null  object 
 19  spore-print-color     267263 non-null   object 
 20  habitat               3116900 non-null  object 
 21  season                3116945 non-null  object 
dtypes: float64(3), int64(1), object(18)
memory usage: 523.2+ MB
</code></pre>
<p>从上面的输出可以看到，训练数据中，第 0 个 column 是 id，第 1 个 column 是 class，后面的 columns 均为详细参数。</p>
<pre><code class="Python">test.info(verbose=True, show_counts=True)
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2077964 entries, 0 to 2077963
Data columns (total 21 columns):
 #   Column                Non-Null Count    Dtype  
---  ------                --------------    -----  
 0   id                    2077964 non-null  int64  
 1   cap-diameter          2077957 non-null  float64
 2   cap-shape             2077933 non-null  object 
 3   cap-surface           1631060 non-null  object 
 4   cap-color             2077951 non-null  object 
 5   does-bruise-or-bleed  2077954 non-null  object 
 6   gill-attachment       1728143 non-null  object 
 7   gill-spacing          1238369 non-null  object 
 8   gill-color            2077915 non-null  object 
 9   stem-height           2077963 non-null  float64
 10  stem-width            2077964 non-null  float64
 11  stem-root             239952 non-null   object 
 12  stem-surface          756476 non-null   object 
 13  stem-color            2077943 non-null  object 
 14  veil-type             106419 non-null   object 
 15  veil-color            251840 non-null   object 
 16  has-ring              2077945 non-null  object 
 17  ring-type             1991769 non-null  object 
 18  spore-print-color     178347 non-null   object 
 19  habitat               2077939 non-null  object 
 20  season                2077964 non-null  object 
dtypes: float64(3), int64(1), object(17)
memory usage: 332.9+ MB
</code></pre>
<h3 id="2-去除-NaN"><a href="#2-去除-NaN" class="headerlink" title="2. 去除 NaN"></a>2. 去除 NaN</h3><pre><code class="Python"># 下面的这些 columns 基本上没有有用信息（全是 NaN）
mostly_nan_cols = [&#39;stem-root&#39;, &#39;stem-surface&#39;, &#39;veil-type&#39;, &#39;veil-color&#39;, &#39;spore-print-color&#39;]

# 这些是含有大量 NaN 的 columns 
many_nan_cols = [&#39;gill-spacing&#39;, &#39;cap-surface&#39;, &#39;gill-attachment&#39;, &#39;ring-type&#39;]

# 去掉全是 NaN 的 columns
train.drop(mostly_nan_cols, axis=1, inplace=True)
test.drop(mostly_nan_cols, axis=1, inplace=True)
</code></pre>
<pre><code class="Python"># 查看 NaN 的数量
pd.DataFrame([train.isna().sum(), test.isna().sum()]).T
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">                              0         1
id                          0.0       0.0
class                       0.0       NaN
cap-diameter                4.0       7.0
cap-shape                  40.0      31.0
cap-surface            671023.0  446904.0
cap-color                  12.0      13.0
does-bruise-or-bleed        8.0      10.0
gill-attachment        523936.0  349821.0
gill-spacing          1258435.0  839595.0
gill-color                 57.0      49.0
stem-height                 0.0       1.0
stem-width                  0.0       0.0
stem-color                 38.0      21.0
has-ring                   24.0      19.0
ring-type              128880.0   86195.0
habitat                    45.0      25.0
season                      0.0       0.0
</code></pre>
<h3 id="3-删除离谱数值"><a href="#3-删除离谱数值" class="headerlink" title="3. 删除离谱数值"></a>3. 删除离谱数值</h3><pre><code class="Python"># 查看每一个 column 中的元素类别有多少
train.nunique()
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">id                      3116945
class                         2
cap-diameter               3913
cap-shape                    74
cap-surface                  83
cap-color                    78
does-bruise-or-bleed         26
gill-attachment              78
gill-spacing                 48
gill-color                   63
stem-height                2749
stem-width                 5836
stem-color                   59
has-ring                     23
ring-type                    40
habitat                      52
season                        4
dtype: int64
</code></pre>
<p>发现有的 columns 中<strong>元素类别特别多</strong>，所以有必要对数据做一些修剪。</p>
<p>接着运行：</p>
<pre><code class="Python"># 所有 columns
categorical_cols = many_nan_cols + [&#39;cap-shape&#39;, &#39;cap-color&#39;, &#39;does-bruise-or-bleed&#39;, &#39;gill-color&#39;, &#39;stem-color&#39;, &#39;has-ring&#39;, &#39;habitat&#39;, &#39;season&#39;]

# 由于过小的数据对我们训练结果的影响微乎其微，所以我们可以将小于100的值全部用 “rare” 替换掉
for c in categorical_cols:
    col_count = train[c].value_counts()
    rare_keys = col_count[col_count&lt;100].index
    train[c] = train[c].replace(rare_keys, &#39;rare&#39;)
    
    col_count = test[c].value_counts()
    rare_keys = col_count[col_count&lt;100].index
    test[c] = test[c].replace(rare_keys, &#39;rare&#39;)

# 再次查看每一个 column 中元素类别数
train.nunique()
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">id                      3116945
class                         2
cap-diameter               3913
cap-shape                     8
cap-surface                  12
cap-color                    13
does-bruise-or-bleed          3
gill-attachment               8
gill-spacing                  4
gill-color                   13
stem-height                2749
stem-width                 5836
stem-color                   14
has-ring                      3
ring-type                     9
habitat                       9
season                        4
dtype: int64
</code></pre>
<p>通过上述操作，类别数减少了一部分</p>
<h3 id="4-填充-NaNs"><a href="#4-填充-NaNs" class="headerlink" title="4. 填充 NaNs"></a>4. 填充 NaNs</h3><pre><code class="Python">for c in train.columns:
    train[c] = train[c].fillna(train[c].mode().values[0])
train.isna().sum()
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">id                      0
class                   0
cap-diameter            0
cap-shape               0
cap-surface             0
cap-color               0
does-bruise-or-bleed    0
gill-attachment         0
gill-spacing            0
gill-color              0
stem-height             0
stem-width              0
stem-color              0
has-ring                0
ring-type               0
habitat                 0
season                  0
dtype: int64
</code></pre>
<p>再对 test 数据进行上述操作：</p>
<pre><code class="Python">for c in test.columns:
    test[c] = test[c].fillna(test[c].mode().values[0])
test.isna().sum()
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">id                      0
cap-diameter            0
cap-shape               0
cap-surface             0
cap-color               0
does-bruise-or-bleed    0
gill-attachment         0
gill-spacing            0
gill-color              0
stem-height             0
stem-width              0
stem-color              0
has-ring                0
ring-type               0
habitat                 0
season                  0
dtype: int64
</code></pre>
<h2 id="四、🧠模型"><a href="#四、🧠模型" class="headerlink" title="四、🧠模型"></a>四、🧠模型</h2><h3 id="1-数据分割"><a href="#1-数据分割" class="headerlink" title="1. 数据分割"></a>1. 数据分割</h3><pre><code class="Python"># 将原始 train 数据分割为 values 和 labels
X = train.drop([&#39;class&#39;, &#39;id&#39;], axis=1)
y = train[&#39;class&#39;]

# 将 70% 的 train 数据用于训练，30% 的数据用于测试（不是待测数据集 test.csv）
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=.3, random_state=4)
</code></pre>
<h3 id="2-将-categories-转变为整型数据"><a href="#2-将-categories-转变为整型数据" class="headerlink" title="2. 将 categories 转变为整型数据"></a>2. 将 categories 转变为整型数据</h3><pre><code class="Python">oe = OrdinalEncoder()
oe.fit(X_train[categorical_cols])
X_train[categorical_cols] = oe.transform(X_train[categorical_cols])
X_test[categorical_cols] = oe.transform(X_test[categorical_cols])
test[categorical_cols] = oe.transform(test[categorical_cols])

encoder = LabelEncoder()
encoder.fit(y_train)
y_train = encoder.transform(y_train)
y_test = encoder.transform(y_test)
</code></pre>
<h3 id="3-特征选择"><a href="#3-特征选择" class="headerlink" title="3. 特征选择"></a>3. 特征选择</h3><pre><code class="Python">def select_features(X_train, y_train):
    fs = SelectKBest(score_func=chi2, k=&#39;all&#39;)
    fs.fit(X_train, y_train)
    X_train_fs = fs.transform(X_train)
    return X_train_fs, fs


# applying feature selection on the training data
X_train_fs, fs = select_features(X_train[categorical_cols], y_train)

# what are scores for the features
for i in range(len(fs.scores_)):
    print(&#39;Feature %d: %f&#39; % (i, fs.scores_[i]))
    
# plot the scores
pyplot.bar([i for i in range(len(fs.scores_))], fs.scores_)
pyplot.show()
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">Feature 0: 20197.118520
Feature 1: 10012.712954
Feature 2: 50523.701865
Feature 3: 39612.848786
Feature 4: 32995.118490
Feature 5: 8665.637682
Feature 6: 5011.635136
Feature 7: 20938.868347
Feature 8: 22027.600984
Feature 9: 8278.886174
Feature 10: 4959.358699
Feature 11: 10198.071977
</code></pre>
<p><img src="/./images/kaggle_s4e8/figure1.png" alt="figure1"></p>
<h3 id="4-准备好-PyTorch-需要用到的数据"><a href="#4-准备好-PyTorch-需要用到的数据" class="headerlink" title="4. 准备好 PyTorch 需要用到的数据"></a>4. 准备好 PyTorch 需要用到的数据</h3><pre><code class="Python"># 使用 GPU
device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;)

# Convert your training and test data to tensors and move them to the correct device
X_train = torch.tensor(X_train.values, dtype=torch.float32).to(device)
X_test = torch.tensor(X_test.values, dtype=torch.float32).to(device)
y_train = torch.tensor(y_train, dtype=torch.float32).reshape(-1, 1).to(device)
y_test = torch.tensor(y_test, dtype=torch.float32).reshape(-1, 1).to(device)

# size of training data
X_train.shape
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">torch.Size([2181861, 15])
</code></pre>
<h3 id="5-模型搭建"><a href="#5-模型搭建" class="headerlink" title="5. 模型搭建"></a>5. 模型搭建</h3><pre><code class="Python"># Notes:
# dropout 设置为 0.5 时效果不佳，0.2 时效果较好
# `self.layers.append(nn.Dropout(dropout_rate))`
class Deep(nn.Module):
    def __init__(self, input_size=X_train.shape[1], hidden_size=128, num_layers=5, dropout_rate=0.2):
        super(Deep, self).__init__()
        
        # Create a list of layers
        self.layers = nn.ModuleList()
        
        # Input layer
        self.layers.append(nn.Linear(input_size, hidden_size*2))
        self.layers.append(nn.ReLU())
        self.layers.append(nn.BatchNorm1d(hidden_size*2))
        
        # Wide hidden layer
        self.layers.append(nn.Linear(hidden_size*2, hidden_size))
        self.layers.append(nn.ReLU())
        self.layers.append(nn.BatchNorm1d(hidden_size))
        
        # Hidden layers
        for _ in range(num_layers - 3):
            self.layers.append(nn.Linear(hidden_size, hidden_size))
            self.layers.append(nn.ReLU())
            self.layers.append(nn.BatchNorm1d(hidden_size))
        
        hiddent_last = int(hidden_size/2)
        
        # Smaller Hidden layer
        self.layers.append(nn.Linear(hidden_size, hiddent_last))
        self.layers.append(nn.ReLU())
        self.layers.append(nn.BatchNorm1d(hiddent_last))
        
        # Output layer
        self.output = nn.Linear(hiddent_last, 1)
        
        # Apply Xavier initialization
        self._initialize_weights()

    def _initialize_weights(self):
        for layer in self.layers:
            if isinstance(layer, nn.Linear):
                nn.init.xavier_uniform_(layer.weight)
        nn.init.xavier_uniform_(self.output.weight)

    def forward(self, x):
        for layer in self.layers:
            x = layer(x)
        x = torch.sigmoid(self.output(x))
        return x

def model_train(model, X_train, y_train, X_val, y_val):
    # Defining the loss function and optimizer
    loss_fn = nn.BCELoss()  # Binary cross-entropy
    optimizer = optim.Adam(model.parameters(), lr=0.0001)

    n_epochs = 250  # Number of epochs to run
    batch_size = 1024*10  # Size of each batch
    batch_start = torch.arange(0, len(X_train), batch_size)

    # Hold the best model
    best_acc = -np.inf  # Initialize to negative infinity
    best_weights = None

    for epoch in range(n_epochs):
        model.train()
        with tqdm.tqdm(batch_start, unit=&quot;batch&quot;, mininterval=0, disable=True) as bar:
            bar.set_description(f&quot;Epoch &#123;epoch&#125;&quot;)
            for start in bar:
                # Take a batch
                X_batch = X_train[start:start+batch_size].to(device)
                y_batch = y_train[start:start+batch_size].to(device)
                # Forward pass
                y_pred = model(X_batch)
                loss = loss_fn(y_pred, y_batch)
                # Backward pass
                optimizer.zero_grad()
                loss.backward()
                # Update weights
                optimizer.step()
                # Print progress
                acc = (y_pred.round() == y_batch).float().mean()
                bar.set_postfix(
                    loss=float(loss),
                    acc=float(acc)
                )
        # Evaluate accuracy at the end of each epoch
        model.eval()
        y_pred = model(X_val.to(device))
        acc = (y_pred.round() == y_val.to(device)).float().mean()
        acc = float(acc)
        if acc &gt; best_acc:
            best_acc = acc
            best_weights = copy.deepcopy(model.state_dict())
    # Restore the best model and return the best accuracy
    model.load_state_dict(best_weights)
    return best_acc
</code></pre>
<p>下面开始训练：</p>
<pre><code class="Python"># 定义 5 倍交叉验证测试工具
kfold = StratifiedKFold(n_splits=5, shuffle=True)
cv_scores_wide = []

for train_idx, test_idx in kfold.split(X_train.cpu(), y_train.cpu()):  # Note: sklearn needs CPU-based numpy arrays
    # Create model, train, and get accuracy
    model = Deep().to(device)
    acc = model_train(model, X_train[train_idx], y_train[train_idx], X_train[test_idx], y_train[test_idx])
    print(&quot;Accuracy (deep): %.4f&quot; % acc)
    cv_scores_wide.append(acc)

# 评估训练效果
acc = np.mean(cv_scores_wide)
std = np.std(cv_scores_wide)
print(&quot;Model accuracy: %.4f%% (+/- %.4f%%)&quot; % (acc * 100, std * 100))
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">Accuracy (deep): 0.9879
Accuracy (deep): 0.9880
Accuracy (deep): 0.9882
Accuracy (deep): 0.9879
Accuracy (deep): 0.9880
Model accuracy: 98.8006% (+/- 0.0103%)
</code></pre>
<h3 id="6-训练效果检验"><a href="#6-训练效果检验" class="headerlink" title="6. 训练效果检验"></a>6. 训练效果检验</h3><pre><code class="Python">model = Deep().to(device)

model.load_state_dict(torch.load(&quot;model.pth&quot;))
model.eval()

threshold = 0.5
y_pred = model(X_test)
y_pred = np.array((y_pred &gt; threshold).float().cpu()) # 0.0 or 1.0

print(f&quot;Accuracy Score: &#123;accuracy_score(y_test.cpu(), y_pred)*100:.3f&#125; %&quot;)
print(f&quot;Matthews Correlation Coefficient (MCC): &#123;matthews_corrcoef(y_test.cpu(), y_pred):.5f&#125;&quot;)
</code></pre>
<p>输出如下：</p>
<pre><code class="Terminal">Accuracy Score: 98.810 %
Matthews Correlation Coefficient (MCC): 0.97598
</code></pre>
<h3 id="7-处理待测数据成为待提交文件"><a href="#7-处理待测数据成为待提交文件" class="headerlink" title="7. 处理待测数据成为待提交文件"></a>7. 处理待测数据成为待提交文件</h3><pre><code class="Python">X_real = test.drop([&#39;id&#39;], axis=1)
X_real = torch.tensor(X_real.values, dtype=torch.float32).to(device)

y_real = model(X_real)

y_real = np.array((y_real &gt; threshold).int().cpu())

# getting the prepared submission file to edit on it
submission = pd.read_csv(&quot;sample_submission.csv&quot;)

# replacing the results with the new one
submission[&#39;class&#39;] = y_real

# converting the 0s and 1s into e-or-p class
submission[&#39;class&#39;] = submission[&#39;class&#39;].astype(&#39;str&#39;)
submission.loc[(submission[&#39;class&#39;] == &#39;0&#39;), &#39;class&#39;] = &#39;e&#39;
submission.loc[(submission[&#39;class&#39;] == &#39;1&#39;), &#39;class&#39;] = &#39;p&#39;
</code></pre>
<h2 id="五、提交检验成果"><a href="#五、提交检验成果" class="headerlink" title="五、提交检验成果"></a>五、提交检验成果</h2><p>最后拿到了 0.975 的准确率💪</p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 Cold Rain&#39;s Blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;冷雨
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
